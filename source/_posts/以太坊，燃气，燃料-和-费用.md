---
title: 以太坊，燃气，燃料 和 费用（翻译）
comments: false
date: 2018-03-01 16:20:06
categories: 区块链
tags:
- ZhouFyk 
- 区块链 
- 以太坊 
- 燃料 
- gas 
- 翻译
img:
---

[来自 BTC Relay 的首席开发人员 Joseph Chow ：Ethereum,Gas,Fuel & Fees](https://media.consensys.net/ethereum-gas-fuel-and-fees-3333e17fe1dc)

以太坊是分布式和诚实的应用程序的平台，可在没有任何管理员或单点故障的全球点对点网络上运行。这些应用程序没有停机时间，任何人都可以创建它们：这是无许可的创新。这些应用是诚实的，不可改变的，并且在编码时总是互操作。从这个角度来说，智能合约的术语是合理的，因为它们是始终遵循其创建时所设定的条款的最终合约。

使这成为可能的核心实际上是世界计算机。在技术上称为以太坊虚拟机（EVM），它包括用于计算和数据存储的操作。交易代表世界计算机内的单个会话，它是交互的单位，类似于句子如何作为语法意义的单位，尽管单个句子可以包含很多单词。

##  燃气（gas）是什么？

燃气是世界计算机使用的计量单位。做一个类比，电量按千瓦小时计量，而在以太坊中使用更多的算力和存储代表着会使用更多的燃气。计量的一个基本原因是它可以激励人们（矿工）操作世界计算机。这些矿工对交易的处理会收取费用，费用则取决于计量方案：燃气。

EVM 中的每个操作都会消耗燃气。例如，一个乘法（`MUL`）消耗 5 燃气而一个加法（`ADD`）消耗 3 燃气。[以太坊操作的燃气消耗表格](https://docs.google.com/spreadsheets/d/1m89CVujrQe5LAFJ8-YAUCcNK950dUzMQPMJBxRtGCqs/edit)

**将燃气看做是燃料的代名词**

计量与费用不同，而燃气和以太币也不同。为了帮助说清楚这个，将燃气看做是燃料的代名词。一笔交易必须提供足够的燃料，或者初始燃气，来支持 EVM 的计算和存储的使用。所有的剩余燃气会回退给交易的发起人：初始化该笔交易的用户。一笔燃料耗尽的交易会回滚，但是依旧包含在区块中，并且相关的费用依旧支付给矿工。

了解了燃料角度的概述，让我们来看看费用相关的概述。在 EVM 中，每个操作都会消耗已经预定义数量的燃气（比如，一个乘法操作总是消耗 5 燃气），用户在每笔交易中都可以指定燃气价格。当前的燃气价格是 0.02μ 以太币，或者 0.00000002 ETH。交易发起人支付给矿工的费用是交易的 `(开始燃气 - 剩余燃气) * 燃气价格`。

这里是一个关于交易燃料和交易费用的影响的总结：

|    |燃料|费用|
|------|-----|------|
|通常|EVM 中的每个操作都会消耗一定数量预先已经设定好的燃料；用户不能更改它。每笔交易都有一个用户指定的初始燃气。|每笔交易都有用户指定的燃料价格（当前默认为每单位燃气 0.02μ ETH）|
|交易开始时|交易发起人应该提供足够的燃料：初始燃气。剩余燃气 = 初始燃气。|交易发起人必须支付所有燃料。放置 `初始燃气 * 燃气价格 = 以太币` 在托管中。|
|每个操作|剩余燃气会由于操作消耗而减少|知道交易完成（不论成功不成功），才会有后续的操作。|
|不成功的交易|剩余燃气为零，还有未完成的操作。这导致一个燃气耗尽的异常，而所有的操作都会被撤销|所有托管的费用都会被支付给矿工|
|成功的交易|所有剩余的燃气会回退给交易发起人|`（初始燃气 - 剩余燃气） * 燃气价格 = 费用` 支付给矿工；`剩余燃气 * 燃气价格` = 回退给交易发起人的费用。|

在交易开始时，被要求用来作为初始燃气的以太币会被搁置，然后剩余燃气值会被设置为初始燃气值。随着交易中的每个操作，燃气会被消耗，剩余燃气逐渐变少。如果发生燃气耗尽的异常，所有的操作都会回滚，而之前搁置的所有的以太币都会被支付给矿工。如果交易成功执行完毕，所有的剩余部分的燃气会回退给交易发起人，而已经消耗的燃气则支付给矿工。

## 简单的例子

在下面的情景模拟中，假设存储消耗 45 燃气，一个加法操作消耗 10 燃气。这个场景涉及到在 EVM 中存储数字 31，将两个数相加，然后存储它们的和。让我们假设交易发起人指定了 150 的初始燃气，和 0.02μ 以太币的燃气价格。下面是 EVM 处理该笔交易的描述：

|   |操作消耗的燃气|剩余燃气|
|------|------|-------|
|交易开始||150|
|存储 31|45|105|
|两个数相加|10|95|
|存储和|45|50|
|交易结束|数字 31 和 加法的和-|-已经被存储写入区块链|

交易发起人支付给矿工的费用是：

**（150–50) × 0.02µETH = 2µETH = 0.000002 ETH**

## 燃料与费用

交易发起人提供足够的燃料与提供足够的费用是有区别的。以下是对交易的可能影响：

||燃料|费用|
|---|---|---|
|太低|不会广播给矿工（错误：`intrinsic gas too low`）|矿工不会执行计算|
|低|少量计算或者燃料耗尽|之后会打包进区块|
|中等|通常是理想的|通常是理想的|
|高|可能导致打包被延迟|尽快被打包入区块|
|太高|不会广播给矿工（错误：`exceeds block gas limit`）|如果交易发起人没有足够的以太币，则不会广播给矿工|

尽管提供了费用，但是一笔燃料很低的交易甚至可能不会到达矿工处。如果一笔交易提供了足够的燃料，但是费用很低，即使该交易到达矿工处，当矿工看到这个费用之后也不会对其进行计算处理。费用决定了交易将被打包进入区块的顺序。而提供高燃料会导致交易打包时间更长的原因在本文中 *高初始燃气可能会导致延迟* 部分。

## 初始燃气

让我们讨论一下交易开始时的燃料需求。抽象地说，在被允许使用世界计算机的计算和存储之前，世界计算机需要知道交易发起人是否有能力支付费用。具体地说，在处理交易之前，矿工需要知道自己是否可以获得报酬。一笔交易需要指定它愿意花费的最大燃料值。对于本文的目的来说，这个需求被称作初始燃气。初始燃气是交易的重要部分。不幸的是，不同的文档使用了不同的词来描述这个关键部分：
* [以太坊白皮书](https://github.com/ethereum/wiki/wiki/White-Paper)中使用了 初始燃气
* [以太坊黄皮书](https://github.com/ethereum/yellowpaper)中使用了燃料限制
* [Geth](https://github.com/ethereum/go-ethereum/releases) 和 [web3.js](https://github.com/ethereum/web3.js/releases) 等软件中，简单地使用了 “燃气”。

因为在通常情况下，不真正运行计算（关联 [停机问题](https://en.wikipedia.org/wiki/Halting_problem)），矿工是不知道到底需要多少计算量的，所以初始燃气使事情变得更加简单（而不用 “燃气作为支付的消耗方式”（away from say a pay as gas is consumed approach） 这种说法）。作为一个以太坊应用的用户，必须提供初始燃气似乎很复杂，但开发人员可以使用一些工具来估计初始燃气并隐藏用户的详细信息。

## 燃料耗尽异常

一笔交易提供了它愿意消耗的最大燃料值。该燃气会被 EVM 中的每个操作消耗。如果燃料消耗完毕，而交易还未完成，那么一个燃料耗尽的异常就会发生。交易发起人为已经执行的操作支付，而交易也被打包进区块，但是所有的状态改变（比如合约的创建，值的存储，和[日志](https://media.consensys.net/technical-introduction-to-events-and-logs-in-ethereum-a074d65dd61e)的写入）都会回滚。

让我们还是使用第一个例子作为场景，但是这次交易发起人指定初始燃气为 90（而不是 150）。这里是执行的示意图：

||操作的燃料消耗|剩余燃料|
|-----|-----|-----|
|交易开始||90|
|存储 31|45|45|
|求和|10|35|
|保存和|45|燃料耗尽|
|交易结束|因为燃料耗尽，存储的 31 会回滚|耗尽|

在交易开始时，交易发起人需要拿出所有燃料的资金： 初始燃气 * 燃气价格 = 存放在柜台的以太币。柜台中的以太币数量为：

**90 × 0.02µETH = 1.8µETH**

当每个操作执行时，燃气会消耗，而在存储和时产生了燃料耗尽异常。这会导致所有的操作撤销，代表数字 31 会被回滚到它之前存储的值，但是交易依旧被打包进入区块链，而且矿工获得所有的酬金：1.8μ ETH。

## 燃气回退

EVM 中有两个负值燃气的操作：
* 清空合约是 -24000
* 清空存储是 -15000

当 EVM 执行了这样的一个操作，它将被记录在单独的退款计数器中。燃气退款仅在交易结束时提供。 此外，最高返还金额等于一半已经消耗的燃气。

一个关键点在于，一笔交易的燃料永远不会增加。当 EVM 执行操作时，燃料总是减少（当一些合约或者存储被清空，退款计数器会增加）。如果燃料到零或者负数，那么立马会产生一个燃料耗尽异常：退款计数器中有多少燃气并不重要。一笔交易为了能够使用燃气退款，它必须避免燃料耗尽异常。假设一笔交易有足够的燃气，然后它就能使用退款计数器中的燃气。

退款的燃气值最多为消耗的燃气值的一半。例如，如果一笔交易使用了 60000 燃气，然后清空了 2 个合约而获得 48000 的一笔退款（每笔 24000），交易发起人还是需要支付给矿工 30000 燃气。这激励了矿工使用负值燃气操作处理交易，因为这给了他们收入，并确保了矿工不可能为他人的计算付款。

## 区块燃气限制（Block gas limit:BGL）

回顾一下，初始燃气由用户指定，是一笔交易将要消耗的燃料最大值。那么一个区块中能够容纳多少交易呢？答案是直到所有交易的初始燃气总和达到区块燃气限制（BGL）为止。当前(2016/6/23)的 BGL 是 4,712,388 （1.5π 的数字形式），表示能够在一个区块（平均出块时间 15 秒）中容纳 224 笔初始燃气为 21000 的交易。为了防止像比特币一样对区块是否变大产生分歧，以太坊协议允许矿工对自己的区块往任意方向进行 1/1024(0.0976%) 幅度的 BGL 调整。与协议不同的是默认的采矿策略，其最小 BGL 为 4,712,388。

## 高初始燃气可能存在的延迟

既然燃料耗尽异常对交易发起人来说几乎是在浪费金钱，那么将初始燃气设置得更高总是更好的。所以，交易发起人为什么不总是将初始燃气指定为 4,000,000 呢？

答案在于交易的初始燃气和它实际消耗的燃气之间的差异。矿工只会获得一笔交易实际消耗的燃气；所有未使用的燃气会被回退给交易发起人。

如果同时存在一笔初始燃气为 4M 的交易和 100 笔初始燃气为 40,000 的交易，矿工可能会选择后者，因为这 100 笔交易的收入有更高的预测性。如果一笔初始燃气为 4M 的交易实际只消耗了 1M 燃气，那么矿工将损失 3M 的潜在燃气收入。所以，矿工更愿意优先考虑一些“小”交易，而不是拥有高初始燃气（除非[内在气体](https://github.com/ethereum/pyethereum/blob/3841e9a406f4ca9452afa45035fb07b5ce6314d9/ethereum/transactions.py#L177)也十分高）的一笔交易。这会导致高初始燃气的交易在被打包之前存在延迟，并且也解释了过高的初始燃气可能会是有害的。

## 绕过交易所

以太坊有两种类型的账户：
* 用户账户（由私钥控制）
* 合约（由代码控制）

发送以太币到一个用户账户需要 21000 的燃气费用，而发送以太币到合约则需要更高的费用，这个费用取决于合约代码和交易中发送的数据。一些交易所会对他们所有的交易都只提供 21000 燃气，这表示在用户想要从交易所发送以太币到他们 Mist（以太坊钱包） 中的合约钱包时，交易会耗尽燃料，以太币永远也不会发送到用户的合约钱包。

## 计量和费用

关于计量和费用之间的区别还有一点需要注意。在比特币中，计量是根据字节来的：交易中的字节数。在以太坊中，计算也需要计量，因为少量的代码也可能被编码成永远执行。计量计算量也是使用燃气的一个原因。但是拥有燃气不代表需要费用。

比如，在一个私链上，每个账户每天可以拥有 X 燃气，或者是每笔交易 Y 燃气，或者其他方案。另一方面，有费用不代表需要燃气：费用可以基于不同的计量，如字节。对于公有链上的安全性来说，燃气和费用两者都需要，而替代方案可能更适合私有链（比如，对于任何人都可以创建账户的公有链来说，每个账户每天有 X 燃气，可以被“女巫攻击”（Sybil-attacked））。

## 结论

燃气是使用世界计算机的计量方式和燃料，与使用世界计算机所支付的以太币费用是不同的。提供足够的燃料和足够的费用，两者之间是有区别的。运行时燃料耗尽会花费钱，而提供更多的燃气会使得更加安全，反正所有的未使用的燃气都会被回退。燃气是以太坊的核心部分，它的大多数话题已经被讨论过。这里有更多关于它的信息，包括[估计燃气](https://github.com/ethereum/wiki/wiki/JavaScript-API#web3ethestimategas)，内在燃气（intrinsic gas），[燃气价格预告（gas price oracle）](https://github.com/ethereum/go-ethereum/wiki/Gas-Price-Oracle)，[交易大小的影响](https://ethereum.stackexchange.com/questions/1106/is-there-a-limit-for-transaction-size)，读者可以在本文的基础上进一步地探索和理解。
